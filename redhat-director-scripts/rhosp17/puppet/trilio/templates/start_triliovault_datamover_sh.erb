<% require 'base64' -%>
#!/bin/bash
<% if @vmware_to_openstack_migration_enabled -%>
if [ -f "/opt/vddk.tar.gz" ]; then
    mkdir -p /opt/vmware-vix-disklib-distrib
    tar xfz /opt/vddk.tar.gz --strip-components=1 -C /opt/vmware-vix-disklib-distrib
    chown -R nova:nova /opt/vmware-vix-disklib-distrib 2> /dev/null
fi
<% end -%>
<% @backup_targets.each do |target| -%>
<% if target['backup_target_type'] == 'nfs' -%>
<% nfs_share = target['nfs_shares'] -%>
<% nfs_dir = nfs_share.split(':')[1] -%>
<% base64_mount_point = Base64.strict_encode64(nfs_dir) -%>
<% nfs_options = target['nfs_options'] -%>
mkdir -p <%= @vault_data_dir %>/<%= base64_mount_point %>
sudo nova-rootwrap /etc/nova/rootwrap.conf mount -t nfs <%= nfs_share %> <%= @vault_data_dir %>/<%= base64_mount_point %> -o <%= nfs_options %>
<% end -%>

<% end -%>

/usr/bin/python3 /usr/bin/tvault-contego \
--config-file=/usr/share/nova/nova-dist.conf --config-file=/etc/nova/nova.conf \
--config-file=/etc/triliovault-datamover/triliovault-datamover.conf

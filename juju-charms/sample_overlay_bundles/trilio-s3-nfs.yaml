series: jammy
variables:
  openstack-origin: &openstack-origin distro
  triliovault-pkg-source: &pkg-source       "deb [trusted=yes] https://apt.fury.io/trilio-stable-6-0 /"

machines:
  '1':
  '2':
  '3':
  '4':

applications:
  trilio-data-mover:
    charm: trilio-charmers-trilio-data-mover
    channel: latest/candidate
    options:
      triliovault-pkg-source: *pkg-source
      backup-target-type: s3
      tv-s3-endpoint-url: <CEPh_S3_URL>
      tv-s3-secret-key: <SECRET_KEY>
      tv-s3-access-key: <ACCESS_KEY>
      tv-s3-region-name: us-east-1
      verbose: True
  trilio-data-mover-mysql-router:
    charm: mysql-router
  trilio-dm-api:
    charm: trilio-charmers-trilio-dm-api
    channel: latest/candidate
    num_units: 1
    options:
       triliovault-pkg-source: *pkg-source
       openstack-origin: *openstack-origin
    to:
      - 'lxd:1'
  trilio-dm-api-mysql-router:
    charm: mysql-router
  trilio-horizon-plugin:
    charm: trilio-charmers-trilio-horizon-plugin
    channel: latest/candidate
    options:
       triliovault-pkg-source: *pkg-source
       openstack-encryption-support: True
  trilio-wlm-mysql-router:
    charm: mysql-router
  trilio-wlm:
    charm: /root/shyam/dev/charm-trilio-wlm/
    num_units: 1
    options:
      triliovault-pkg-source: *pkg-source
      openstack-origin: *openstack-origin
      trilio-backup-targets: >
        [
          {
            "backup-target-name": "S3_BT1",
            "backup-target-type": "s3",
            "is-default": true,
            "s3-type": "amazon_s3",
            "s3-access-key": "<ACCESS_KEY>",
            "s3-secret-key": "<SECRET_KEY>",
            "s3-region-name": "us-west-2",
            "s3-bucket": "<BUCKET_NAME>",
            "s3-endpoint-url": "",
            "s3-signature-version": "default",
            "s3-auth-version": "DEFAULT",
            "s3-ssl-enabled": true,
            "s3-ssl-verify": true,
            "s3-self-signed-cert": false,
            "s3-ssl-ca_cert": "",
            "s3-bucket-object-lock-enabled": false
          },
          {
            "backup-target-name": "S3_BT1",
            "backup-target-type": "s3",
            "is-default": true,
            "s3-type": "other_s3",
            "s3-access-key": "<ACCESS_KEY>",
            "s3-secret-key": "<SECRET_KEY>",
            "s3-region-name": "us-east-1",
            "s3-bucket": "<BUCKET_NAME>",
            "s3-endpoint-url": "<CEPH_S3_URL>",
            "s3-signature-version": "default",
            "s3-auth-version": "DEFAULT",
            "s3-ssl-enabled": true,
            "s3-ssl-verify": true,
            "s3-self-signed-cert": true,
            "s3-ssl-ca_cert": "-----BEGIN CERTIFICATE-----
        SHKLLEffdfdfdfggdgdrrasbgnYJKoZIhvcNAQELBQAwgZAxCzAJBgNVBAYTAklO
        MQswCQYDVQQIDAJNSDENMAsGA1UEBwwEUFVORTEPMA0GA1UECgwGVFJJTElPMQsw
        CQYDVQQLDAJJVDEaMBgGA1UEAwwRKi50cmlsaW9kYXRhLmRlbW8xKzApBgkqhkiG
        9w0BCQEWHHBnqewlrodhssaksldgffegegrgmfvvdkcsoejdHhcNMTkwNjEzMDkx
        -----END CERTIFICATE-----",
            "s3-bucket-object-lock-enabled": false
          },
          {
            "backup-target-name": "NFS_BT3",
            "backup-target-type": "nfs",
            "is-default": false,
            "nfs-shares": "<NFS_SHARE>",
            "nfs-options": "nolock,soft,timeo=600,intr,lookupcache=none,nfsvers=3,retrans=10"
          }
        ]
      verbose: True
      trustee-role: creator,member
    to:
      - '1'
relations:
  # Triliovault horizon plugin relations
  # # relation with openstack-dashboard
  - - trilio-horizon-plugin:dashboard-plugin
    - openstack-dashboard:dashboard-plugin

  # Triliovault Datamover-API relations
  # # relation with keystone
  - - trilio-dm-api:identity-service
    - keystone:identity-service
  # # relation with db router
  - - trilio-dm-api:shared-db
    - trilio-dm-api-mysql-router:shared-db
  # # relation with AMQP server
  - - trilio-dm-api:amqp
    - rabbitmq-server:amqp
  # # relation with vault certificates
  - - trilio-dm-api:certificates
    - vault:certificates
  # # relation with DB server from the router
  - - trilio-dm-api-mysql-router:db-router
    - mysql-innodb-cluster:db-router

  # Triliovault Datamover relations
  # # relation with AMQP server
  - - trilio-data-mover:amqp
    - rabbitmq-server:amqp
  # # relation with nova-compute for sub-ordinating
  - - trilio-data-mover:juju-info
    - nova-compute:juju-info
  # # relation with db router
  - - trilio-data-mover:shared-db
    - trilio-data-mover-mysql-router:shared-db
  # # relation with CEPH
  - - trilio-data-mover:ceph
    - ceph-mon:client
  # # relation with DB server from the router
  - - trilio-data-mover-mysql-router:db-router
    - mysql-innodb-cluster:db-router
  # # A workaround for db router to work for trilio-datamover
  - - nova-compute:juju-info
    - trilio-data-mover-mysql-router:juju-info

  # Triliovault Workloadmgr relations
  # # relation with db router
  - - trilio-wlm:shared-db
    - trilio-wlm-mysql-router:shared-db
  # # relation with AMQP server
  - - trilio-wlm:amqp
    - rabbitmq-server:amqp
  # # relation with keystone
  - - trilio-wlm:identity-service
    - keystone:identity-service
  # # relation with vault certificates
  - - trilio-wlm:certificates
    - vault:certificates
  # # relation with DB server from the router
  - - mysql-innodb-cluster:db-router
    - trilio-wlm-mysql-router:db-router
